import os
import random
import asyncio
from flask import Flask, request
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

TOKEN = "8416342563:AAF2yDXKKdTdFS92xXDHcjJ6XXqiSDHKQbM"
WEBHOOK_URL = "https://elena-tg-bot.onrender.com/webhook"

# Все твои фразы (полный список)
phrases = [
    '*_Доверься процессу_*',
    '*_Сегодня важна тишина_*',
    '*_Делай меньше — чувствуй больше_*',
    '*_Будь, а не делай_*',
    '*_Ты не один_*',
    '*_Ты в правильном месте_*',
    '*_Не спеши_*',
    '*_Ты не обязан быть сильным_*',
    '*_Главное — дыши_*',
    '*_Ты — не твои мысли_*',
    '*_Все приходит вовремя_*',
    '*_Слушай сердце_*',
    '*_Сейчас важно отпустить_*',
    '*_Доверяй, но проверяй_*',
    '*_Любовь в мелочах_*',
    '*_Пусть мир подождет_*',
    '*_Ты уже достаточно_*',
    '*_Цени свой путь_*',
    '*_Твоя сила в мягкости_*',
    '*_Все идет как надо_*',
    '*_Смотри глубже_*',
    '*_Ты сильнее, чем кажется_*',
    '*_Не беги от себя_*',
    '*_Твоя душа знает путь_*',
    '*_Свет внутри тебя_*',
    '*_Все сложится_*',
    '*_Сила — в тишине_*',
    '*_Покой — это действие_*',
    '*_Сейчас — лучшее время_*',
    '*_Ты — часть мира_*',
    '*_Остановись и вдохни_*',
    '*_Мир на твоей стороне_*',
    '*_Пусть будет легко_*',
    '*_Ты — поток_*',
    '*_Нежность — твоя сила_*',
    '*_Не бойся перемен_*',
    '*_Все начинается с тебя_*',
    '*_Чудеса рядом_*',
    '*_Сила в настоящем_*',
    '*_Отпусти ожидания_*',
    '*_Слушай интуицию_*',
    '*_Ты ценнее, чем думаешь_*',
    '*_Благодари за путь_*',
    '*_Улыбнись миру_*',
    '*_Вдохни новое_*',
    '*_Не сравнивай себя_*',
    '*_Все пройдет_*',
    '*_Тебе можно отдыхать_*',
    '*_Ты заслуживаешь лучшего_*',
    '*_Свет ведет тебя_*',
    '*_Слушай шепот души_*',
    '*_Сила в мягкости_*',
    '*_Небо поддержит_*',
    '*_Смотри внутрь_*',
    '*_Ты не обязан быть идеальным_*',
    '*_Не держи лишнего_*',
    '*_Все будет по-другому_*',
    '*_Прими неизвестность_*',
    '*_Твои шаги важны_*',
    '*_Ты важен_*',
    '*_Стань тише — услышишь больше_*',
    '*_Уважай свой ритм_*',
    '*_Дыши глубже_*',
    '*_Пусть будет так, как есть_*',
    '*_Делай паузу_*',
    '*_Ты уже дома_*',
    '*_Не гонись за всем_*',
    '*_Сохрани свет_*',
    '*_Верь в себя_*',
    '*_Смелость — это мягкость_*',
    '*_Ты и есть ответ_*',
    '*_Любовь ведет_*',
    '*_Сейчас — достаточно_*',
    '*_Пусть жизнь течет_*',
    '*_Ты часть целого_*',
    '*_Ты — добро_*',
    '*_Не обесценивай себя_*',
    '*_Внутри спокойствие_*',
    '*_Нежность к себе_*',
    '*_Ты под защитой_*',
    '*_Слушай знаки_*',
    '*_Ты — творец_*',
    '*_Ты больше, чем кажется_*',
    '*_Все сложится вовремя_*',
    '*_Твои мечты важны_*',
    '*_Свет внутри_*',
    '*_Стань мягче_*',
    '*_Ты — чудо_*',
    '*_Не сомневайся_*',
    '*_Все идет правильно_*',
    '*_Ты — поток жизни_*',
    '*_Тебе можно ошибаться_*',
    '*_Ты — смысл_*',
    '*_Смотри сердцем_*',
    '*_Сила быть собой_*',
    '*_Ты на пути_*',
    '*_Ты важнее дел_*',
    '*_Отпусти старое_*',
    '*_Все получится_*',
    '*_Дыши сердцем_*',
    '*_Даже если кажется, что ты в темноте — ты движешься._*',
    '*_Состояние покоя — не лень. Это мудрость._*',
    '*_Ты не потерял путь. Ты просто отдыхаешь._*',
    '*_Сегодня день, чтобы замедлить сердце._*',
    '*_Ты не в долгу перед миром за то, что заботишься о себе._*',
    '*_Не торопи свое восстановление._*',
    '*_Ты можешь быть целым, даже если чувствуешь себя разбитым._*',
    '*_Твое нет может быть актом любви к себе._*',
    '*_Будь как река — найди путь, не ломая берегов._*',
    '*_Твоя чувствительность — это дар, а не бремя._*',
    '*_Ты не сломался. Ты трансформируешься._*',
    '*_Покой — это не отсутствие движения, это глубина._*',
    '*_Сегодня выбери себя._*',
    '*_Иногда просто чай и тишина — это всё, что нужно._*',
    '*_Ты — не результат, ты — путь._*',
    '*_Доверяй паузам. В них рождается ясность._*',
    '*_Сегодня можно не спешить._*',
    '*_Ты — не твои страхи._*',
    '*_Можно быть нежным и целеустремлённым._*',
    '*_Не сравнивай своё состояние с чужим прогрессом._*',
    '*_Твое медленно — тоже движение._*',
    '*_Пусть сегодня будет день мягким._*'
]

# Все цвета (полный)
colors = [
    '*_Лазурный — цвет покоя и глубины_*',
    '*_Изумрудный — цвет восстановления_*',
    '*_Фиолетовый — цвет мистики и вдохновения_*',
    '*_Песочный — цвет мягкой устойчивости_*',
    '*_Алый — цвет решительности и страсти_*',
    '*_Бирюзовый — цвет свежести_*',
    '*_Сиреневый — цвет внутреннего мира_*',
    '*_Нежно-розовый — цвет заботы_*',
    '*_Оливковый — цвет мудрости_*',
    '*_Голубой — цвет ясности_*',
    '*_Золотой — цвет изобилия_*',
    '*_Серебристый — цвет обновления_*',
    '*_Глубокий синий — цвет тишины_*',
    '*_Теплый оранжевый — цвет радости_*',
    '*_Янтарный — цвет теплоты_*',
    '*_Пастельно-зеленый — цвет гармонии_*',
    '*_Сливовый — цвет загадочности_*',
    '*_Белый — цвет чистоты_*',
    '*_Бежевый — цвет комфорта_*',
    '*_Коралловый — цвет мягкой силы_*',
    '*_Индиго — цвет интуиции_*',
    '*_Горчичный — цвет стойкости_*',
    '*_Мятный — цвет свежего начала_*',
    '*_Пурпурный — цвет внутренней силы_*',
    '*_Светло-серый — цвет покоя_*',
    '*_Теплый коричневый — цвет земли_*',
    '*_Пудровый — цвет нежности_*',
    '*_Светло-желтый — цвет радости_*',
    '*_Шоколадный — цвет тепла_*',
    '*_Малахитовый — цвет природы_*',
    '*_Сапфировый — цвет глубины_*',
    '*_Песочно-розовый — цвет уюта_*',
    '*_Туманно-серый — цвет мягкости_*',
    '*_Розово-золотой — цвет заботы_*',
    '*_Лавандовый — цвет спокойствия_*',
    '*_Светлый терракот — цвет корней_*',
    '*_Травяной — цвет жизни_*',
    '*_Яшмовый — цвет устойчивости_*',
    '*_Океанический — цвет широты_*',
    '*_Теплый фуксия — цвет дерзости_*'
]

# Все состояния (полный)
states = [
    '*_Слушай тишину – там больше ответов, чем в шуме._*',
    '*_Сегодня не обязательно быть сильным. Достаточно быть настоящим._*',
    '*_Оставь место для чуда._*',
    '*_Ты не обязан светиться каждый день. Иногда достаточно просто быть._*',
    '*_Мягкость — это тоже сила._*',
    '*_Если устал — замедлись, но не сдавайся._*',
    '*_Все, что тебе нужно, уже внутри._*',
    '*_Сегодня хороший день, чтобы почувствовать себя живым._*',
    '*_Твое дыхание — якорь в настоящем._*',
    '*_Смотри на облака. В них больше свободы, чем в новостях._*',
    '*_Позволь себе чувствовать. Даже если это неудобно._*',
    '*_Ты не должен быть продуктивным, чтобы быть ценным._*',
    '*_Спокойствие — это не слабость, а глубина._*',
    '*_Делай медленно. Это тоже путь._*',
    '*_Ты не опаздываешь. У тебя свой ритм._*',
    '*_Иногда самое важное — это просто остаться с собой._*',
    '*_Ты можешь сказать нет и все равно быть хорошим._*',
    '*_Чувствуй землю под ногами. Это уже достаточно._*',
    '*_Интуиция — это голос, который редко кричит._*',
    '*_Сегодня выбери то, что тебя наполняет._*',
    '*_Доверяй своей усталости — она не враг._*',
    '*_Иногда хаос — это начало порядка._*',
    '*_Ты — не твоя тревога._*',
    '*_Замени ожидание — на принятие._*',
    '*_Нежность — это форма мудрости._*',
    '*_Можно быть уставшим и все еще целым._*',
    '*_Не спеши проживать жизнь. Она не убегает._*',
    '*_Быть собой — уже достаточно._*',
    '*_Пауза — это не остановка, это настройка._*',
    '*_Ты можешь быть и уязвимым, и сильным одновременно._*',
    '*_Не нужно объяснять свою тишину._*',
    '*_Мир не рушится, он просто дышит иначе._*',
    '*_Будь к себе так же добр, как ты бы был к другу._*',
    '*_Ты — не проект. Тебя не нужно всё время улучшать._*',
    '*_Сегодня — не репетиция. Живи его мягко._*',
    '*_Оставь место для неопределенности._*',
    '*_Ты не должен все знать. Ты учишься жить._*',
    '*_Даже туманное утро может быть началом солнца._*',
    '*_Позволь себе ошибаться. Это тоже рост._*',
    '*_Сохрани тишину внутри, даже если снаружи шторм._*',
    '*_Ты — процесс, а не продукт._*',
    '*_Иногда лучшее, что ты можешь сделать — это ничего._*',
    '*_Сегодня — день для медленных ответов._*',
    '*_Дыши. Просто дыши. Этого уже много._*',
    '*_Отпустить — не значит забыть. Это значит дышать легче._*',
    '*_Ты можешь быть светом для себя._*',
    '*_Иногда лучший план — это его отсутствие._*',
    '*_Будь там, где твое тело._*',
    '*_Усталость — не слабость, а сигнал._*',
    '*_Позволь себе не знать, что дальше._*',
    '*_Ты не теряешь время, если заботишься о себе._*',
    '*_Ты не обязан спасать всех._*',
    '*_Мир не требует от тебя быть идеальным._*',
    '*_Ты — не только то, что ты делаешь._*',
    '*_Не отвечай сразу. Иногда лучше почувствовать._*',
    '*_Твое тело умнее, чем ты думаешь._*'
]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Привет! Нажми кнопку и получи свой случайный опорный ориентир на сегодня 🌿",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == "📝 Фраза дня":
        await update.message.reply_text(random.choice(phrases), parse_mode="Markdown")
    elif text == "🎨 Цвет дня":
        await update.message.reply_text(random.choice(colors), parse_mode="Markdown")
    elif text == "🫧 Состояние дня":
        await update.message.reply_text(random.choice(states), parse_mode="Markdown")
    else:
        await update.message.reply_text("Нажми на одну из кнопок ниже, чтобы получить подсказку 🌿")

# === Flask & Telegram setup ===

flask_app = Flask(__name__)
telegram_app = ApplicationBuilder().token(TOKEN).build()

telegram_app.add_handler(CommandHandler("start", start))
telegram_app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

@flask_app.route("/")
def index():
    return "Бот запущен и работает! ✅"

@flask_app.route("/webhook", methods=["POST"])
async def webhook():
    if request.method == "POST":
        update = Update.de_json(request.get_json(force=True), telegram_app.bot)
        await telegram_app.process_update(update)
        return "ok", 200

async def set_webhook():
    await telegram_app.bot.set_webhook(WEBHOOK_URL)
    print("Webhook установлен!")

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))

    # Запускаем Telegram-бота
    loop = asyncio.get_event_loop()
    loop.run_until_complete(set_webhook())
    telegram_app.initialize()
    flask_app.run(host="0.0.0.0", port=port)
